# Sprint 1 - Slice S1-C: Advisor Invite System

**Date**: 2026-01-30
**Branch**: `lesson-53`
**Mode**: AUTONOMY

---

## Objective

Allow existing advisors to invite new advisors via invite codes. This mirrors the existing student invite system but is specific to the advisor role.

---

## Changes Made

### 1. Migration: `20260130044608_advisor_invites.sql`

Created the `advisor_invites` table with:
- `id` (uuid, primary key)
- `invited_by` (uuid, references profiles)
- `invite_code` (text, unique)
- `email` (text, optional)
- `expires_at` (timestamptz, default 7 days)
- `accepted_at` (timestamptz, null until used)
- `accepted_by` (uuid, references profiles)
- `created_at` (timestamptz)

**RLS Policies:**
- `advisor_invites_insert` - Only advisors/admins can create invites
- `advisor_invites_select_own` - Advisors can view invites they created
- `advisor_invites_select_by_code` - Any authenticated user can read by code (for validation)

**Function: `accept_advisor_invite(invite_code_input text)`**
- SECURITY DEFINER function
- Validates code exists, not used, not expired
- Updates invite record with `accepted_at` and `accepted_by`
- Sets user's role to `advisor`
- Creates `advisor_profile` record if needed

### 2. New Page: `app/join/advisor/page.tsx`

Advisor invite code acceptance page following the pattern from `/join` (student invites):
- Auth mode toggle (sign-up / sign-in)
- Email and password fields (email required for advisors)
- Invite code input (8 characters, case-insensitive)
- Calls `accept_advisor_invite` RPC function
- Redirects to `/advisor` dashboard on success

### 3. New Component: `components/AdvisorInviteModal.tsx`

Modal for generating advisor invite codes:
- Generates 8-character alphanumeric codes (excludes ambiguous chars like 0/O, 1/I/L)
- Inserts invite record to `advisor_invites` table
- Displays code with copy button
- Optional email input with mailto link
- 7-day expiration

### 4. Modified: `components/AdvisorDashboard.tsx`

Added:
- Import for `AdvisorInviteModal` and `UserPlus` icon
- State for `isInviteModalOpen`
- "Invite Advisor" button in header (next to Create Assignment)
- `AdvisorInviteModal` component instance

### 5. Updated: `src/types/supabase.ts`

Added TypeScript types for:
- `advisor_invites` table (Row, Insert, Update, Relationships)
- `accept_advisor_invite` function signature

---

## Commands Executed

1. `supabase migration new advisor_invites` - Created migration file
2. `supabase db push` - Applied migration to remote
3. `supabase db pull` - Verified schema sync
4. `supabase migration list` - Confirmed migration status
5. `npm run lint` - No errors
6. `npm run build` - Successful (13/13 pages)

---

## Files Changed

| File | Action |
|------|--------|
| `supabase/migrations/20260130044608_advisor_invites.sql` | Created |
| `app/join/advisor/page.tsx` | Created |
| `components/AdvisorInviteModal.tsx` | Created |
| `components/AdvisorDashboard.tsx` | Modified |
| `src/types/supabase.ts` | Modified |

---

## Lint/Build Results

- **Lint**: No ESLint warnings or errors
- **Build**: Compiled successfully (13/13 static pages)
- **Note**: Pre-existing persona auth warning (unrelated to this slice)

---

## Manual Test Path

1. Login as existing advisor
2. Click "Invite Advisor" button in dashboard header
3. Click "Generate code" - observe 8-char code displayed
4. Copy code or note it down
5. Log out
6. Navigate to `/join/advisor`
7. Enter invite code
8. Enter email and password (create new account)
9. Submit form
10. Verify redirect to `/advisor` dashboard
11. Verify role is set to `advisor` in database

**Edge cases to test:**
- Using an already-accepted code (should fail with "Invite already used")
- Using an expired code (should fail with "Invite expired")
- Invalid code format (should fail with "Invite not found")

---

## Acceptance Criteria Status

- [x] Advisors can generate 8-char invite codes
- [x] `/join/advisor` accepts codes and sets role to advisor
- [x] Used codes cannot be reused (validated in DB function)
- [x] Codes expire after 7 days (validated in DB function)

---

## Known Limitations

1. No UI to view previously generated invite codes (can be added later)
2. No way to revoke an unused invite code (can add delete functionality)
3. Email field on invite is optional and not validated (could add email verification)

---

## Next Steps

- S1-E verification complete
- Ready to commit and push all changes
